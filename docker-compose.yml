services:
  ingestion:
    build:
      context: .
      dockerfile: docker/ingestion.Dockerfile
    command: >-
      python3 resnet101/scripts/cli_ingest.py
      --data-dir /workspace/data
      --stats-path /workspace/data/pet_stats.json
      --report-path /workspace/monitoring/ingestion_report.json
    volumes:
      - ./data:/workspace/data
      - ./monitoring:/workspace/monitoring
    restart: "no"

  training:
    build:
      context: .
      dockerfile: docker/training.Dockerfile
    command: >-
      python3 resnet101/scripts/cli_train.py
      --config /workspace/resnet101/oxford_pets_binary_resnet101.yaml
      --output-dir /workspace/resnet101/model_trained/mlops
      --tracking-uri file:/workspace/resnet101/mlruns
    volumes:
      - ./data:/workspace/data
      - ./resnet101:/workspace/resnet101
      - ./monitoring:/workspace/monitoring
    depends_on:
      ingestion:
        condition: service_completed_successfully
    restart: "no"

  deploy:
    build:
      context: .
      dockerfile: docker/deploy.Dockerfile
    command: python3 scripts/run_api.py --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      ENABLE_INFERENCE_LOGGING: "true"
      INFERENCE_LOG_PATH: /workspace/monitoring/inference_events.jsonl
    volumes:
      - ./data:/workspace/data
      - ./resnet101:/workspace/resnet101
      - ./monitoring:/workspace/monitoring
    restart: unless-stopped
